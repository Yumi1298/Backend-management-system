<%- include("../parts/html-head") %>

<style>
  .required {
    color: red;
  }

  .form-text {
    color: red;
  }

  #purchase-source option:first-child {
    color: #888; /* 設置灰色 */
  }
</style>
<%- include("../parts/navbar") %>

<div id="layoutSidenav">
  <%- include("../parts/layout-sidenav") %>
  <div id="layoutSidenav_content">
    <main>
      <div class="container-fluid px-4">
        <h1 class="mt-4">新增資料</h1>

        <div class="card my-3" style="max-width: 45rem">
          <div class="card-body p-5">
            <form name="form1" onsubmit="sendData(event)">
              <!-- 姓名和生日 -->
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="name" class="form-label">
                    <span class="required">**</span> 姓名
                  </label>
                  <input
                    type="text"
                    class="form-control"
                    id="name"
                    name="name"
                  />
                  <div class="form-text"></div>
                </div>
                <div class="col-md-6">
                  <label for="birthday" class="form-label">
                    <span class="required">**</span> 生日
                  </label>
                  <input
                    type="date"
                    class="form-control"
                    id="birthday"
                    name="birthday"
                  />
                  <div class="form-text"></div>
                </div>
              </div>

              <!-- 手機號碼 -->
              <div class="mb-3">
                <label for="mobile" class="form-label">
                  <span class="required">**</span> 手機號碼
                </label>
                <input
                  type="text"
                  class="form-control"
                  id="mobile"
                  name="mobile"
                />
                <div class="form-text"></div>
              </div>

              <!-- 產品序號 -->
              <div class="mb-3">
                <label for="product_id" class="form-label">產品序號</label>
                <input
                  class="form-control"
                  id="product_id"
                  name="product_id"
                  rows="3"
                />
                <div class="form-text"></div>
              </div>
              <!-- 購買日期和來源 -->
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="purchase_date" class="form-label">購買日期</label>
                  <input
                    type="date"
                    class="form-control"
                    id="purchase_date"
                    name="purchase_date"
                  />
                  <div class="form-text"></div>
                </div>
                <div class="col-md-6">
                  <label for="purchase_source" class="form-label"
                    >購買來源</label
                  >
                  <select
                    id="purchase_source"
                    name="purchase_source"
                    class="form-select"
                  >
                    <option>---請選擇購買來源---</option>
                    <option value="網路購買">網路購買</option>
                    <option value="實體店面">實體店面</option>
                    <option value="其他">其他</option>
                  </select>
                  <div class="form-text"></div>
                </div>
              </div>

              <!-- 按鈕 -->
              <div class="d-flex justify-content-end gap-2 mt-5">
                <button type="submit" class="btn btn-dark">新增資料</button>
                <a href="/user" class="btn btn-secondary">到列表頁</a>
              </div>
            </form>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- Modal -->
<div
  class="modal fade"
  id="exampleModal"
  tabindex="-1"
  aria-labelledby="exampleModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="exampleModalLabel">資料新增結果</h1>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-success" role="alert">資料新增成功</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          繼續新增
        </button>
        <a href="/user" class="btn btn-dark">到列表頁</a>
      </div>
    </div>
  </div>
</div>
<%- include("../parts/scripts") %>
<script>
  const nameField = document.form1.name;
  const birthdayField = document.form1.birthday;
  const mobileField = document.form1.mobile;

  // 限制日期不能超過今天
  document.addEventListener("DOMContentLoaded", function () {
    const today = new Date().toISOString().split("T")[0]; // 取得今天日期

    // 設定 max 屬性
    document.getElementById("birthday").setAttribute("max", today);
    document.getElementById("purchase_date").setAttribute("max", today);
  });

  function validateBirthday(birthday) {
    var re = /^\d{4}-\d{2}-\d{2}$/;
    return re.test(birthday);
  }

  function validateMobile(mobile) {
    var re = /^09\d{8}$/;
    return re.test(mobile);
  }

  const sendData = (e) => {
    e.preventDefault();

    // 回復沒有提示的狀態
    nameField.style.border = "1px solid #CCCCCC";
    nameField.nextElementSibling.innerHTML = "";
    birthdayField.style.border = "1px solid #CCCCCC";
    birthdayField.nextElementSibling.innerHTML = "";
    mobileField.style.border = "1px solid #CCCCCC";
    mobileField.nextElementSibling.innerHTML = "";

    let isPass = true; // 有沒有通過檢查

    // TODO: 要做欄位資料檢查
    if (nameField.value.length < 2) {
      isPass = false;
      // 跳提示用戶
      nameField.style.border = "1px solid red";
      nameField.nextElementSibling.innerHTML = "請填寫正確的姓名";
    }

    if (!validateBirthday(birthday.value)) {
      isPass = false;
      birthday.style.border = "1px solid red";
      birthday.nextElementSibling.innerHTML = "請填寫正確的日期格式";
    }

    if (!validateMobile(mobile.value)) {
      isPass = false;
      mobile.style.border = "1px solid red";
      mobile.nextElementSibling.innerHTML = "請填寫正確的手機";
    }

    // 如果欄位資料都有通過檢查
    if (isPass) {
      const fd = new FormData(document.form1); // 建立一個只有資料的表單物件

      fetch("", {
        method: "POST",
        body: fd, // 預設的 Content-Type: multipart/form-data
      })
        .then((r) => r.json())
        .then((data) => {
          console.log(data);
          if (data.success) {
            myModal.show();
          } else {
            console.log(`資料新增失敗`);
          }
        })
        .catch((ex) => {
          console.log(`fetch() 發生錯誤, 回傳的 JSON 格式是錯的`);
          console.log(ex);
        });
    }
  };

  const myModal = new bootstrap.Modal("#exampleModal");
</script>
<%- include("../parts/html-foot") %>
